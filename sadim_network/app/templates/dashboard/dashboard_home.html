<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard/dashboard_home.css') }}">

<h2 class="title">ุฅุญุตุงุฆูุงุช ุงูุฒูุงุฑ ุงูุฑูููุฉ</h2>

<div class="admin-controls" style="margin-top: 2rem; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
    <form action="{{ url_for('admin.delete_visits') }}" method="post" style="display:inline;">
        <button type="submit" class="btn-action btn-delete" onclick="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ูุงูุฉ ุงูุณุฌูุงุชุ ูุง ูููู ุงูุชุฑุงุฌุน!');">
            <i class="fas fa-trash-alt"></i> ุญุฐู ุงูุณุฌู ุจุงููุงูู
        </button>
    </form>
    
    <a href="{{ url_for('admin.admin_users_list') }}" class="btn-action btn-nav">
        <i class="fas fa-users"></i> ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
    </a>
    <a href="{{ url_for('admin.add_user') }}" class="btn-action btn-nav">
        <i class="fas fa-user-plus"></i> ุฅุถุงูุฉ ุนุถู
    </a>
    <a href="{{ url_for('admin.services_dashboard') }}" class="btn-action btn-nav">
        <i class="fas fa-arrow-right"></i> ููุญุฉ ุงูุชุญูู
    </a>

</div>

<div class="dashboard-controls">
    <div class="filter-group">
        <button class="btn-filter active" onclick="SadeemDash.applyTimeFilter('all', this)">ุงููู</button>
        <button class="btn-filter" onclick="SadeemDash.applyTimeFilter('today', this)">ุงูููู</button>
        <button class="btn-filter" onclick="SadeemDash.applyTimeFilter('hour', this)">ุขุฎุฑ ุณุงุนุฉ</button>
    </div>
    <input type="text" class="search-box" id="dashSearch" placeholder="๐ ุงุจุญุซ ุนู IP ุฃู ุตูุญุฉ...">
    <button class="btn-action btn-nav" onclick="SadeemDash.exportToCSV()">
        <i class="fas fa-file-download"></i> ุชุญููู ุงูุฃุฑุดูู ุงูุชุญูููู (CSV)
    </button>
</div>

<div class="stats-container" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
    <div class="card" style="flex: 1; min-width: 300px;">
        <h4 style="color: var(--color-light); margin-bottom: 15px;">๐ ููุน ุงูุฒูุงุฑุงุช</h4>
        <canvas id="typeChart" style="max-height: 200px;"></canvas>
    </div>
    <div class="card" style="flex: 1; min-width: 300px;">
        <h4 style="color: var(--color-light); margin-bottom: 15px;">๐ฑ ุงูุฃุฌูุฒุฉ</h4>
        <canvas id="deviceChart" style="max-height: 200px;"></canvas>
    </div>
    <div class="card" style="flex: 1; min-width: 300px;">
        <h4 style="color: var(--color-light); margin-bottom: 15px;">๐ ุงูุฃูุซุฑ ุทูุจุงู (ุจุดุฑ)</h4>
        <ul id="topPaths" style="text-align: right; color: var(--color-light); list-style: none; padding: 0;"></ul>
    </div>
</div>

<div class="table-wrapper" style="margin-top: 2rem;">
    <table class="styled-table" id="logsTable">
        <thead>
            <tr>
                <th>IP ุงูุนููุงู</th>
                <th>ุงูุฌูุงุฒ (UA)</th>
                <th>ุงููุณุงุฑ</th>
                <th>ุงูุชูููุช</th>
            </tr>
        </thead>
        <tbody>
            {% for v in visits %}
            <tr class="log-row">
                <td class="ip-cell">{{ v[0] }}</td>
                <td class="ua-cell" title="{{ v[1] }}">{{ v[1] }}</td>
                <td class="page-cell">{{ v[2] }}</td>
                <td class="time-cell">{{ v[3] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>



<script>
const SadeemDash = {
    store: [],
    charts: {},
    currentFilter: 'all',

    init() {
        this.parseTable();
        this.initCharts();
        this.setupSearch();
        this.refresh();
    },

    parseTable() {
        const rows = document.querySelectorAll(".log-row");
        this.store = Array.from(rows).map(row => ({
            el: row,
            ip: row.cells[0].innerText.trim(),
            ua: row.cells[1].getAttribute('title') || row.cells[1].innerText.toLowerCase(),
            path: row.cells[2].innerText.trim(),
            date: new Date(row.cells[3].innerText.replace(/-/g, '/'))
        }));
    },

    applyFilters() {
        const searchTerm = document.getElementById('dashSearch').value.toLowerCase();
        const now = new Date();

        this.store.forEach(item => {
            const matchesSearch = item.ip.includes(searchTerm) || item.path.toLowerCase().includes(searchTerm);
            let matchesTime = true;
            if (this.currentFilter === 'today') {
                matchesTime = item.date.toDateString() === now.toDateString();
            } else if (this.currentFilter === 'hour') {
                matchesTime = (now - item.date) < 3600000;
            }
            item.el.classList.toggle('hidden-row', !(matchesSearch && matchesTime));
        });
        this.refresh();
    },

    applyTimeFilter(mode, btn) {
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this.currentFilter = mode;
        this.applyFilters();
    },

    setupSearch() {
        let timeout;
        document.getElementById('dashSearch').addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => this.applyFilters(), 250);
        });
    },

    getVisibleStats() {
        const visible = this.store.filter(i => !i.el.classList.contains('hidden-row'));
        const stats = {
            type: { human: 0, bot: 0, files: 0 },
            device: { desktop: 0, mobile: 0 },
            paths: {}
        };

        visible.forEach(item => {
            const isFile = item.path.match(/\.(css|js|jpg|jpeg|png|gif|svg|ico|webp)$/i);
            
            if (item.ua.includes('bot') || item.ua.includes('crawl')) {
                stats.type.bot++;
            } else if (isFile) {
                stats.type.files++;
            } else {
                stats.type.human++;
                stats.paths[item.path] = (stats.paths[item.path] || 0) + 1;
            }

            if (/mobile|android|iphone|ipad/i.test(item.ua)) stats.device.mobile++;
            else stats.device.desktop++;
        });
        return stats;
    },

    refresh() {
        const stats = this.getVisibleStats();
        
        if (this.charts.type) {
            this.charts.type.data.datasets[0].data = [stats.type.human, stats.type.bot, stats.type.files];
            this.charts.type.update();
        }

        if (this.charts.device) {
            this.charts.device.data.datasets[0].data = [stats.device.desktop, stats.device.mobile];
            this.charts.device.update();
        }

        const topPathsEl = document.getElementById('topPaths');
        const sortedPaths = Object.entries(stats.paths).sort((a,b) => b[1] - a[1]).slice(0,5);
        
        topPathsEl.innerHTML = sortedPaths.length ? sortedPaths.map(([p,c]) => 
            `<li><span>${p}</span><strong style="color:#00cec9">${c}</strong></li>`
        ).join('') : '<li style="opacity:0.5; font-size:0.8rem">ูุง ุชูุฌุฏ ุจูุงูุงุช ุณููููุฉ...</li>';
    },

    initCharts() {
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: '#fff', font: { size: 10 } } }
            },
            cutout: '70%'
        };

        this.charts.type = new Chart(document.getElementById('typeChart'), {
            type: 'doughnut',
            data: {
                labels: ['ุจุดุฑ','ุจูุชุงุช','ูููุงุช'],
                datasets: [{ 
                    data: [0,0,0], 
                    backgroundColor: ['#00cec9','#d63031','#854f6c'], 
                    borderWidth: 0 
                }]
            },
            options: chartOptions
        });

        this.charts.device = new Chart(document.getElementById('deviceChart'), {
            type: 'doughnut',
            data: {
                labels: ['ููุจููุชุฑ','ุฌูุงู'],
                datasets: [{ 
                    data: [0,0], 
                    backgroundColor: ['#fdcb6e','#0984e3'], 
                    borderWidth: 0 
                }]
            },
            options: chartOptions
        });
    },

    exportToCSV() {
        let csv = "\uFEFF"; 
        csv += "ุงูุฑูู,IP ุงูุนููุงู,ุงููุณุงุฑ ุงููุณุชูุฏู,ุงูุชูููุช ุงููุญูู,ููุน ุงูุฌูุงุฒ,ุงูุชุตููู ุงูุณูููู,ุจูุงูุงุช ุงูุฌูุงุฒ ุงููุงููุฉ\n";
        
        this.store.forEach((l, index) => {
            const isMobile = /mobile|android|iphone|ipad/i.test(l.ua);
            const deviceType = isMobile ? "ุฌูุงู" : "ููุจููุชุฑ";
            
            let category = "ุจุดุฑ";
            if (l.ua.includes('bot') || l.ua.includes('crawl')) category = "ุจูุช/ุฒุงุญู";
            else if (l.path.match(/\.(css|js|jpg|png|ico|svg|webp)$/i)) category = "ุทูุจ ูููุงุช";

            const cleanUA = l.ua.replace(/,/g, ';');
            const formattedDate = l.date.toLocaleString('ar-SA');

            csv += `${index + 1},${l.ip},${l.path},"${formattedDate}",${deviceType},${category},${cleanUA}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Sadeem_Behavior_Analysis_${new Date().toLocaleDateString()}.csv`;
        link.click();
    }
};

document.addEventListener("DOMContentLoaded", () => SadeemDash.init());
</script>