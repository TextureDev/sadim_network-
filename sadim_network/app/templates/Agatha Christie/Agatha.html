<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مكتبة أجاثا كريستي الملكية | سديم</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/Agatha.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Cinzel:wght@400;700&family=Tajawal:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    

</head>
<body>

<div class="overlay" id="overlay"></div>

<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span style="font-family: 'Cinzel'; color: var(--soft-gold);">SADEEM</span>
        <i class="fa-solid fa-xmark fa-xl" onclick="toggleMenu()" style="cursor:pointer; color:var(--soft-gold)"></i>
    </div>
    <ul>
        <li><a href="{{ url_for('main.index') }}">الرئيسية</a></li>

        <li><a href="{{url_for('admin.show_services')}}"><i class="fa-solid fa-gem"></i> خدماتنا</a></li>
        <li><a href="{{url_for('main.about')}}"><i class="fa-solid fa-feather-pointed"></i> من نحن</a></li>
        <li><a href="mailto:thazraa2019@gmail.com"><i class="fa-solid fa-envelope"></i> اتصل بنا</a></li>
    </ul>
</nav>

<header>
    <button class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars-staggered"></i></button>
    <a href="{{ url_for('loading_bp.landing_page') }}" class="brand">
        <span class="top">SADEEM</span>
        <span class="sub">ROYAL LIBRARY</span>
    </a>
    <ul class="nav-links-desktop">
        <li><a href="{{ url_for('main.index') }}">الرئيسية</a></li>

        <li><a href="{{url_for('admin.show_services')}}">خدماتنا</a></li>
        <li><a href="{{url_for('main.about')}}">من نحن</a></li>
    </ul>
    <div class="user-action">
        {% if session.user_id %}
            <a href="{{ url_for('loading_bp.account') }}" style="color: var(--soft-gold);"><i class="fa-regular fa-circle-user fa-xl"></i></a>
        {% else %}
            <a href="{{ url_for('loading_bp.login') }}" class="btn-royal" style="padding: 6px 20px;">دخول</a>
        {% endif %}
    </div>
</header>

<section class="about-agatha">
    <img src="https://upload.wikimedia.org/wikipedia/commons/c/cf/Agatha_Christie.png" alt="Agatha" class="about-img">
    <div class="about-content">
        <h2 style="color: var(--soft-gold); font-family: 'Amiri', serif;">أجاثا كريستي.. سيدة الغموض</h2>
        <p>الروائية الأكثر مبيعاً في التاريخ؛ اكتشف عالم الجريمة والذكاء عبر مكتبتنا الملكية.</p>
    </div>
</section>

<section class="progress-container">
    {% set total_books = 66 %}
    {% set current_books = books|length %}
    {% set percent = (current_books / total_books * 100)|round|int %}
    <div style="display:flex; justify-content:space-between; margin-bottom:8px; color:var(--soft-gold); font-size:0.9rem;">
        <span>اكتمل رفع <strong>{{ current_books }}</strong> من {{ total_books }}</span>
        <span>{{ percent }}%</span>
    </div>
    <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: {{ percent }}%;"></div></div>
</section>

<div class="book-grid">
    {% for book in books %}
    <div class="book-card">
        <div class="cover-container">
            <img src="{{ url_for('Library_Agatha.static', filename='uploads/' + book.cover_path) }}?v={{ book.id }}" alt="{{ book.title }}" loading="lazy">
        </div>
        
        <div class="download-stats">
            <i class="fa-solid fa-cloud-arrow-down"></i> 
            <span id="count-{{ book.id }}">{{ book.download_count if book.download_count else 0 }}</span> تحميلة
        </div>

        <h3 class="book-title">{{ book.title }}</h3>
        
        <p style="font-size: 0.8rem; color: #ccc; margin-bottom: 15px; height: 3.2em; overflow: hidden; opacity: 0.7;">
            {{ book.desc_text | truncate(75) }}
        </p>
        
        {% if session.get('user_id') %}
            <a href="{{ url_for('Library_Agatha.download_file', book_id=book.id) }}" 
               class="btn-royal" 
               onclick="updateCount(event, {{ book.id }}, this.href)">
                <i class="fa-solid fa-download"></i> تحميل PDF ملكي
            </a>
        {% else %}
            <a href="{{ url_for('loading_bp.login', next=request.path) }}" class="btn-royal" style="border-style: dashed;">
                <i class="fa-solid fa-lock"></i> سجل دخول للتحميل
            </a>
        {% endif %}
    </div>
    {% endfor %}
</div>
<section class="source-notice">
    <div class="source-container">
        <div class="source-icon"><i class="fa-solid fa-circle-info"></i></div>
        <div class="source-content">
            <h4>مصدر الكتب</h4>
            <p>تم جلب هذه الكتب من موقع <a href="https://archive.org" target="_blank">archive.org</a> بموجب تراخيص المشاع الإبداعي. في حال وجود اعتراض، يرجى <a href="mailto:moslah20040@gmail.com">التواصل معنا</a>.</p>
        </div>
    </div>
</section>

<footer class="legal-footer">
    <i class="fa-solid fa-scale-balanced" style="color: var(--soft-gold); font-size: 1.5rem; margin-bottom: 10px;"></i>
    <h4 style="color: var(--soft-gold); font-family: 'Cinzel'; margin: 0 0 10px 0;">INTELLECTUAL PROPERTY</h4>
    <p style="font-size: 0.8rem; opacity: 0.6;">جميع المؤلفات تقع ضمن نطاق الملكية العامة وفق القوانين الدولية.</p>
</footer>

<script>
    function toggleMenu() {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('overlay').classList.toggle('active');
    }
    document.getElementById('overlay').onclick = toggleMenu;

    // دالة تحديث العداد اللحظي
    function updateCount(event, bookId, downloadUrl) {
        // نرسل طلب تحديث العداد في الخلفية
        fetch(`/library/increment_download/${bookId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const countSpan = document.getElementById(`count-${bookId}`);
                if (countSpan) {
                    countSpan.innerText = data.new_count;
                    // تأثير وميض بسيط
                    countSpan.style.color = "#fff";
                    setTimeout(() => { countSpan.style.color = "var(--soft-gold)"; }, 500);
                }
            }
        })
        .catch(err => console.error("Error updating counter:", err));

        // لا نمنع سلوك الرابط الأصلي، سيقوم المتصفح ببدء التحميل تلقائياً
    }
</script>

</body>
</html>